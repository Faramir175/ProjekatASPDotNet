@model MojAtar.Core.DTO.RadnjaDTO
@using Newtonsoft.Json

@{
    ViewData["Title"] = "Dodaj / Izmeni Radnju";
}

@if (!ViewData.ModelState.IsValid)
{
    foreach (var modelError in ViewData.ModelState.Values.SelectMany(v => v.Errors))
    {
        <div class="alert alert-danger">@modelError.ErrorMessage</div>
    }
}

<div class="container py-5">
    @if (ViewBag.ErrorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            @ViewBag.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Zatvori"></button>
        </div>
    }

    <div class="container-glass">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>@(Model.Id == null ? "Dodaj Radnju" : "Izmeni Radnju")</h2>

            @if (ViewBag.FromParcelaId != null)
            {
                <a asp-action="RadnjePoParceli" asp-route-idParcela="@ViewBag.FromParcelaId" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Nazad
                </a>
            }
            else if (Model.Id != null && Model.Parcele != null && Model.Parcele.Any())
            {
                <a asp-action="RadnjePoParceli" asp-route-idParcela="@Model.Parcele.First().IdParcela" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Nazad
                </a>
            }
            else
            {
                <a asp-action="Radnje" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Nazad
                </a>
            }
        </div>

        @if (ViewBag.SetvaZakljucana == true)
        {
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle"></i>
                Ova setva je <strong>zaključana</strong> jer je za nju već obavljena žetva.
                Možete pregledati podatke, ali izmene nisu dozvoljene.
            </div>
        }

        @if (ViewBag.SetvaZakljucana == true)
        {
            <fieldset disabled style="opacity:0.85;">
                <form method="post" asp-action="@(Model.Id == null ? "Dodaj" : "Izmeni")" asp-controller="Radnja">
                    @if (Model.Id != null)
                    {
                        <input type="hidden" asp-for="Id" />
                    }
                    <div id="obrisaneMasineContainer"></div>
                    <div id="obrisanePrikljucneContainer"></div>
                    <div id="obrisaniResursiContainer"></div>

                    <div class="mb-4">
                        <label class="form-label h5 d-block mb-2">Parcele</label>

                        <div class="scrollable-list">
                            @{
                                // Mapiramo postojeće parcele da ih lako pronađemo po ID-u
                                var postojeceParcele = Model.Parcele?.ToDictionary(p => p.IdParcela, p => p)
                                ?? new Dictionary<Guid, MojAtar.Core.DTO.RadnjaParcelaDTO>();
                            }

                            @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.ParceleSelectList)
                            {
                                var pId = Guid.Parse(item.Value);
                                var isChecked = postojeceParcele.ContainsKey(pId);
                                var podaciOParceli = isChecked ? postojeceParcele[pId] : null;

                                <div class="parcela-item d-flex flex-wrap align-items-center justify-content-between">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                               @(isChecked ? "checked" : "") disabled>
                                        <label class="form-check-label fw-bold" style="opacity: 1;">
                                            @item.Text
                                        </label>
                                    </div>

                                    @if (isChecked)
                                    {
                                        <div class="parcela-detalji d-flex gap-2 align-items-center">
                                            @if (Model.TipRadnje == MojAtar.Core.Domain.Enums.RadnjaTip.Setva)
                                            {
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text bg-light">Površina (ha)</span>
                                                    <input type="text" class="form-control detail-input"
                                                           value="@(podaciOParceli?.Povrsina.ToString() ?? "-")"
                                                           readonly style="background-color: #fff;" />
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Napomena" class="form-label">Napomena</label>
                        <textarea asp-for="Napomena" class="form-control" rows="3" readonly></textarea>
                    </div>

                    <div class="mb-3">
                        <label>Kultura</label>
                        <select asp-for="IdKultura" class="form-control" asp-items="ViewBag.KultureSelectList" disabled>
                            <option value="">-- Kultura --</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label h5 d-block mb-2">Parcele</label>
                        <small class="text-muted d-block mb-3">
                            @(Model.Id == null ? "Izaberite parcele na kojima se radnja obavlja." : "Parcele se ne mogu menjati tokom izmene, samo podaci.")
                        </small>

                        <div class="d-flex flex-wrap gap-2 mb-3">
                            @{
                                // Pripremamo podatke o već selektovanim parcelama
                                var selektovaneParcele = Model.Parcele?.ToDictionary(p => p.IdParcela, p => p)
                                ?? new Dictionary<Guid, MojAtar.Core.DTO.RadnjaParcelaDTO>();
                            }

                            @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.ParceleSelectList)
                            {
                                var pId = Guid.Parse(item.Value);
                                var isChecked = selektovaneParcele.ContainsKey(pId);

                                <div class="form-check masina-card shadow-sm p-2 bg-light rounded" style="min-width: 150px;">
                                    <input class="form-check-input parcela-checkbox" type="checkbox"
                                           id="p_@pId"
                                           value="@pId"
                                           data-naziv="@item.Text"
                                           @(isChecked ? "checked" : "")
                                           @(Model.Id != null ? "disabled" : "")>

                                    <label class="form-check-label fw-bold" for="p_@pId" style="@(Model.Id != null ? "opacity:0.7" : "")">
                                        @item.Text
                                    </label>
                                </div>
                            }
                        </div>

                        <div id="parceleDetaljiContainer">
                            @{
                                int pIndex = 0;
                            }
                            @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.ParceleSelectList)
                            {
                                var pId = Guid.Parse(item.Value);
                                var isChecked = selektovaneParcele.ContainsKey(pId);
                                var existingData = isChecked ? selektovaneParcele[pId] : null;

                                // Renderujemo detalje SAMO za one koji su već u modelu (za Edit) ili koji su checked
                                if (isChecked)
                                {
                                    <div class="mb-3 parcela-row" id="unos-parcela-@pId">
                                        <label class="form-label fw-bold text-success">
                                            <i class="bi bi-geo-alt-fill"></i> @item.Text
                                        </label>

                                        <input type="hidden" name="Parcele[@pIndex].IdParcela" value="@pId" class="p-id-input" />

                                        <div class="p-povrsina-wrapper mt-1">
                                            <div class="input-group">
                                                <span class="input-group-text">Površina (ha)</span>
                                                <input type="number" step="0.0001" min="0.0001"
                                                       name="Parcele[@pIndex].Povrsina"
                                                       class="form-control p-povrsina-input"
                                                       value="@(existingData?.Povrsina.ToString().Replace(",", ".") ?? "")"
                                                       placeholder="Unesite površinu" />
                                            </div>
                                            <small class="text-muted slobodna-lbl" id="lbl-slobodno-@pId"></small>
                                        </div>
                                    </div>
                                    pIndex++;
                                }
                            }
                        </div>
                    </div>

                    @if (Model.Id == null)
                    {
                        <div class="mb-3">
                            <label asp-for="DatumIzvrsenja" class="form-label">Datum izvršenja</label>
                            <input asp-for="DatumIzvrsenja" class="form-control" type="date" />
                            <span asp-validation-for="DatumIzvrsenja" class="text-danger"></span>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label asp-for="DatumIzvrsenja" class="form-label">Datum izvršenja</label>
                            <input asp-for="DatumIzvrsenja" class="form-control" type="date" readonly />
                            <span asp-validation-for="DatumIzvrsenja" class="text-danger"></span>
                            <small class="text-muted">Datum izvršenja se ne može menjati nakon unosa radnje.</small>
                        </div>
                    }


                    @if (Model.Id == null)
                    {
                        <div class="mb-3">
                            <label asp-for="TipRadnje" class="form-label">Tip radnje</label>
                            <select asp-for="TipRadnje" class="form-control" asp-items="Html.GetEnumSelectList<MojAtar.Core.Domain.Enums.RadnjaTip>()"></select>
                            <span asp-validation-for="TipRadnje" class="text-danger"></span>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label>Tip radnje</label>
                            <select asp-for="TipRadnje" class="form-control" disabled id="TipRadnje">
                                <option value="@Model.TipRadnje" selected>@Model.TipRadnje</option>
                            </select>
                            <span asp-validation-for="TipRadnje" class="text-danger"></span>
                            <input type="hidden" asp-for="TipRadnje" />
                        </div>
                    }

                    <div class="mb-3">
                        <label asp-for="Napomena" class="form-label">Napomena</label>
                        <textarea asp-for="Napomena" class="form-control" rows="4" style="min-height: 120px; resize: vertical;"></textarea>
                        <small class="text-muted">Unesi dodatne detalje o radnji (opciono).</small>
                    </div>


                    <div class="mb-3">
                        <label for="IdKultura">Kultura</label>
                        <select asp-for="IdKultura" class="form-control" asp-items="ViewBag.KultureSelectList">
                            <option value="">-- Izaberite kulturu --</option>
                        </select>
                    </div>


                    <div class="mb-3" id="prinosDiv" style="display:@(Model.TipRadnje == MojAtar.Core.Domain.Enums.RadnjaTip.Zetva ? "block" : "none")">
                        <label asp-for="Prinos" class="form-label">Prinos (kg)</label>
                        <input asp-for="Prinos" class="form-control" type="number" step="0.01" />
                        <span asp-validation-for="Prinos" class="text-danger"></span>
                    </div>

                    <div id="listaMasina" class="mb-4">
                        <label class="form-label d-block mb-2">Radne mašine</label>

                        <!-- kartice -->
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            @{
                                var povezaneMasine = Model.RadneMasine?.ToDictionary(rm => rm.IdRadnaMasina, rm => (double)rm.BrojRadnihSati)
                                ?? new Dictionary<Guid, double>();
                                int index = 0;
                            }

                            @foreach (var masina in (IEnumerable<SelectListItem>)ViewBag.RadneMasineSelectList)
                            {
                                var isChecked = povezaneMasine.ContainsKey(Guid.Parse(masina.Value));
                                <div class="form-check masina-card shadow-sm">
                                    <input class="form-check-input masina-checkbox" type="checkbox"
                                           id="masinaCheckbox_@masina.Value" value="@masina.Value" data-naziv="@masina.Text"
                                           @(isChecked ? "checked" : "") />
                                    <label class="form-check-label fw-semibold" for="masinaCheckbox_@masina.Value">
                                        @masina.Text
                                    </label>
                                </div>
                            }
                        </div>

                        <!-- ✅ ispod kartica prikaz broja sati -->
                        <div id="masineDetaljiContainer">
                            @foreach (var masina in (IEnumerable<SelectListItem>)ViewBag.RadneMasineSelectList)
                            {
                                var isChecked = povezaneMasine.ContainsKey(Guid.Parse(masina.Value));
                                if (isChecked)
                                {
                                    <div class="mb-3" id="unos-masina-@masina.Value">
                                        <label class="form-label">Radna mašina: @masina.Text – broj sati</label>
                                        <input type="hidden" name="RadneMasine[@index].IdRadnaMasina" value="@masina.Value" />
                                        <input type="number" name="RadneMasine[@index].BrojRadnihSati"
                                               class="form-control" step="1" min="1"
                                               value="@povezaneMasine[Guid.Parse(masina.Value)]" required />
                                    </div>
                                    index++;
                                }
                            }
                        </div>
                    </div>



                    <div id="listaPrikljucnihMasina" class="mb-4">
                        <label class="form-label d-block mb-2">Priključne mašine</label>
                        <div class="d-flex flex-wrap gap-2">
                            @{
                                var povezanePrikljucne = Model.PrikljucneMasine?
                                .Select(pm => pm.IdPrikljucnaMasina)
                                .ToHashSet()
                                ?? new HashSet<Guid>();
                                int indexPrik = 0;
                            }

                            @foreach (var masina in (IEnumerable<SelectListItem>)ViewBag.PrikljucneMasineSelectList)
                            {
                                var isChecked = povezanePrikljucne.Contains(Guid.Parse(masina.Value));
                                <div class="form-check prikljucna-card shadow-sm">
                                    <input class="form-check-input prikljucna-checkbox" type="checkbox"
                                           id="prikljucnaCheckbox_@masina.Value" value="@masina.Value" data-naziv="@masina.Text"
                                           @(isChecked ? "checked" : "") />
                                    <label class="form-check-label fw-semibold" for="prikljucnaCheckbox_@masina.Value">
                                        @masina.Text
                                    </label>
                                </div>

                                if (isChecked)
                                {
                                    <input type="hidden" name="PrikljucneMasine[@indexPrik].IdPrikljucnaMasina" value="@masina.Value" />
                                    indexPrik++;
                                }
                            }
                        </div>
                    </div>


                    <div id="prikljucneDetaljiContainer"></div>

                    <div id="listaResursa" class="mb-4">
                        <label class="form-label d-block mb-2">Resursi</label>
                        <div class="d-flex flex-wrap gap-2">
                            @{
                                var povezaniResursi = (Model.Resursi ?? new List<MojAtar.Core.DTO.RadnjaResursDTO>())
                                .ToDictionary(r => r.IdResurs, r => r.Kolicina);

                            }

                            @foreach (var resurs in (IEnumerable<SelectListItem>)ViewBag.ResursiSelectList)
                            {
                                var isChecked = povezaniResursi.ContainsKey(Guid.Parse(resurs.Value));
                                <div class="form-check resurs-card shadow-sm">
                                    <input class="form-check-input resurs-checkbox" type="checkbox"
                                           id="resursCheckbox_@resurs.Value" value="@resurs.Value" data-naziv="@resurs.Text"
                                           @(isChecked ? "checked" : "") />
                                    <label class="form-check-label fw-semibold" for="resursCheckbox_@resurs.Value">
                                        @resurs.Text
                                    </label>
                                </div>
                            }
                        </div>
                    </div>


                    <div id="resursDetaljiContainer">
                        @{
                            int indexResurs = 0;
                        }
                        @foreach (var resurs in (IEnumerable<SelectListItem>)ViewBag.ResursiSelectList)
                        {
                            var isChecked = povezaniResursi.ContainsKey(Guid.Parse(resurs.Value));
                            if (isChecked)
                            {
                                var resData = povezaniResursi[Guid.Parse(resurs.Value)];

                                <div class="mb-3" id="unos-resurs-@resurs.Value" style="display: block;">
                                    <label class="form-label">Resurs: @resurs.Text – količina</label>
                                    <input type="number" name="Resursi[@indexResurs].Kolicina"
                                           class="form-control mb-2 resurs-kolicina-input"
                                           step="0.1" min="0" value="@resData" required />
                                    <input type="hidden" name="Resursi[@indexResurs].IdResurs" value="@resurs.Value" />
                                </div>
                                indexResurs++;
                            }
                        }
                    </div>

                    <div id="ukupanTrosakPrikaz" class="mt-3">
                        <strong>
                            Ukupan trošak:
                            <span id="ukupanTrosak">
                                @(Model.Id != null ? Model.UkupanTrosak.ToString("0.00") : "0.00")
                            </span> RSD
                        </strong>
                    </div>

                    <input type="hidden" name="UkupanTrosak" value="@(Model.Id != null ? Model.UkupanTrosak.ToString("0.00") : "0.00")" />

                    <button type="submit" class="btn btn-success mt-3">Sačuvaj</button>
                </form>
            </fieldset>
        }
        else
        {
            <form method="post" asp-action="@(Model.Id == null ? "Dodaj" : "Izmeni")" asp-controller="Radnja">
                @if (Model.Id != null)
                {
                    <input type="hidden" asp-for="Id" />
                }
                <div id="obrisaneMasineContainer"></div>
                <div id="obrisanePrikljucneContainer"></div>
                <div id="obrisaniResursiContainer"></div>

                <div class="mb-4">
                    <label class="form-label h5 d-block mb-2">Parcele</label>
                    <small class="text-muted d-block mb-3">
                        @(Model.Id == null ? "Izaberite parcele na kojima se radnja obavlja." : "Parcele se ne mogu menjati tokom izmene, samo podaci.")
                    </small>

                    <div class="d-flex flex-wrap gap-2 mb-3">
                        @{
                            // Pripremamo podatke o već selektovanim parcelama
                            var selektovaneParcele = Model.Parcele?.ToDictionary(p => p.IdParcela, p => p)
                            ?? new Dictionary<Guid, MojAtar.Core.DTO.RadnjaParcelaDTO>();
                        }

                        @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.ParceleSelectList)
                        {
                            var pId = Guid.Parse(item.Value);
                            var isChecked = selektovaneParcele.ContainsKey(pId);

                            <div class="form-check masina-card shadow-sm p-2 bg-light rounded" style="min-width: 150px;">
                                <input class="form-check-input parcela-checkbox" type="checkbox"
                                       id="p_@pId"
                                       value="@pId"
                                       data-naziv="@item.Text"
                                       @(isChecked ? "checked" : "")
                                       @(Model.Id != null ? "disabled" : "")>

                                <label class="form-check-label fw-bold" for="p_@pId" style="@(Model.Id != null ? "opacity:0.7" : "")">
                                    @item.Text
                                </label>
                            </div>
                        }
                    </div>

                    <div id="parceleDetaljiContainer">
                        @{
                            int pIndex = 0;
                        }
                        @foreach (var item in (IEnumerable<SelectListItem>)ViewBag.ParceleSelectList)
                        {
                            var pId = Guid.Parse(item.Value);
                            var isChecked = selektovaneParcele.ContainsKey(pId);
                            var existingData = isChecked ? selektovaneParcele[pId] : null;

                            // Renderujemo detalje SAMO za one koji su već u modelu (za Edit) ili koji su checked
                            if (isChecked)
                            {
                                <div class="mb-3 parcela-row" id="unos-parcela-@pId">
                                    <label class="form-label fw-bold text-success">
                                        <i class="bi bi-geo-alt-fill"></i> @item.Text
                                    </label>

                                    <input type="hidden" name="Parcele[@pIndex].IdParcela" value="@pId" class="p-id-input" />

                                    <div class="p-povrsina-wrapper mt-1">
                                        <div class="input-group">
                                            <span class="input-group-text">Površina (ha)</span>
                                            <input type="number" step="0.0001" min="0.0001"
                                                   name="Parcele[@pIndex].Povrsina"
                                                   class="form-control p-povrsina-input"
                                                   value="@(existingData?.Povrsina.ToString().Replace(",", ".") ?? "")"
                                                   placeholder="Unesite površinu" />
                                        </div>
                                        <small class="text-muted slobodna-lbl" id="lbl-slobodno-@pId"></small>
                                    </div>
                                </div>
                                pIndex++;
                            }
                        }
                    </div>
                </div>

                @if (Model.Id == null)
                {
                    <div class="mb-3">
                        <label asp-for="DatumIzvrsenja" class="form-label">Datum izvršenja</label>
                        <input asp-for="DatumIzvrsenja" class="form-control" type="date" />
                        <span asp-validation-for="DatumIzvrsenja" class="text-danger"></span>
                    </div>
                }
                else
                {
                    <div class="mb-3">
                        <label asp-for="DatumIzvrsenja" class="form-label">Datum izvršenja</label>
                        <input asp-for="DatumIzvrsenja" class="form-control" type="date" readonly />
                        <span asp-validation-for="DatumIzvrsenja" class="text-danger"></span>
                        <small class="text-muted">Datum izvršenja se ne može menjati nakon unosa radnje.</small>
                    </div>
                }


                @if (Model.Id == null)
                {
                    <div class="mb-3">
                        <label asp-for="TipRadnje" class="form-label">Tip radnje</label>
                        <select asp-for="TipRadnje" class="form-control" asp-items="Html.GetEnumSelectList<MojAtar.Core.Domain.Enums.RadnjaTip>()"></select>
                        <span asp-validation-for="TipRadnje" class="text-danger"></span>
                    </div>
                }
                else
                {
                    <div class="mb-3">
                        <label>Tip radnje</label>
                        <select asp-for="TipRadnje" class="form-control" disabled id="TipRadnje">
                            <option value="@Model.TipRadnje" selected>@Model.TipRadnje</option>
                        </select>
                        <span asp-validation-for="TipRadnje" class="text-danger"></span>
                        <input type="hidden" asp-for="TipRadnje" />
                    </div>
                }

                <div class="mb-3">
                    <label asp-for="Napomena" class="form-label">Napomena</label>
                    <textarea asp-for="Napomena" class="form-control" rows="4" style="min-height: 120px; resize: vertical;"></textarea>
                    <small class="text-muted">Unesi dodatne detalje o radnji (opciono).</small>
                </div>


                <div class="mb-3">
                    <label for="IdKultura">Kultura</label>
                    <select asp-for="IdKultura" class="form-control" asp-items="ViewBag.KultureSelectList">
                        <option value="">-- Izaberite kulturu --</option>
                    </select>
                </div>

                <div class="mb-3" id="prinosDiv" style="display:@(Model.TipRadnje == MojAtar.Core.Domain.Enums.RadnjaTip.Zetva ? "block" : "none")">
                    <label asp-for="Prinos" class="form-label">Prinos (kg)</label>
                    <input asp-for="Prinos" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="Prinos" class="text-danger"></span>
                </div>

                <div id="listaMasina" class="mb-4">
                    <label class="form-label d-block mb-2">Radne mašine</label>

                    <!-- kartice -->
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        @{
                            var povezaneMasine = Model.RadneMasine?.ToDictionary(rm => rm.IdRadnaMasina, rm => (double)rm.BrojRadnihSati)
                            ?? new Dictionary<Guid, double>();
                            int index = 0;
                        }

                        @foreach (var masina in (IEnumerable<SelectListItem>)ViewBag.RadneMasineSelectList)
                        {
                            var isChecked = povezaneMasine.ContainsKey(Guid.Parse(masina.Value));
                            <div class="form-check masina-card shadow-sm">
                                <input class="form-check-input masina-checkbox" type="checkbox"
                                       id="masinaCheckbox_@masina.Value" value="@masina.Value" data-naziv="@masina.Text"
                                       @(isChecked ? "checked" : "") />
                                <label class="form-check-label fw-semibold" for="masinaCheckbox_@masina.Value">
                                    @masina.Text
                                </label>
                            </div>
                        }
                    </div>

                    <!-- ✅ ispod kartica prikaz broja sati -->
                    <div id="masineDetaljiContainer">
                        @foreach (var masina in (IEnumerable<SelectListItem>)ViewBag.RadneMasineSelectList)
                        {
                            var isChecked = povezaneMasine.ContainsKey(Guid.Parse(masina.Value));
                            if (isChecked)
                            {
                                <div class="mb-3" id="unos-masina-@masina.Value">
                                    <label class="form-label">Radna mašina: @masina.Text – broj sati</label>
                                    <input type="hidden" name="RadneMasine[@index].IdRadnaMasina" value="@masina.Value" />
                                    <input type="number" name="RadneMasine[@index].BrojRadnihSati"
                                           class="form-control" step="1" min="1"
                                           value="@povezaneMasine[Guid.Parse(masina.Value)]" required />
                                </div>
                                index++;
                            }
                        }
                    </div>
                </div>

                <div id="listaPrikljucnihMasina" class="mb-4">
                    <label class="form-label d-block mb-2">Priključne mašine</label>
                    <div class="d-flex flex-wrap gap-2">
                        @{
                            var povezanePrikljucne = Model.PrikljucneMasine?
                            .Select(pm => pm.IdPrikljucnaMasina)
                            .ToHashSet()
                            ?? new HashSet<Guid>();
                            int indexPrik = 0;
                        }

                        @foreach (var masina in (IEnumerable<SelectListItem>)ViewBag.PrikljucneMasineSelectList)
                        {
                            var isChecked = povezanePrikljucne.Contains(Guid.Parse(masina.Value));
                            <div class="form-check prikljucna-card shadow-sm">
                                <input class="form-check-input prikljucna-checkbox" type="checkbox"
                                       id="prikljucnaCheckbox_@masina.Value" value="@masina.Value" data-naziv="@masina.Text"
                                       @(isChecked ? "checked" : "") />
                                <label class="form-check-label fw-semibold" for="prikljucnaCheckbox_@masina.Value">
                                    @masina.Text
                                </label>
                            </div>

                            if (isChecked)
                            {
                                <input type="hidden" name="PrikljucneMasine[@indexPrik].IdPrikljucnaMasina" value="@masina.Value" />
                                indexPrik++;
                            }
                        }
                    </div>
                </div>


                <div id="prikljucneDetaljiContainer"></div>

                <div id="listaResursa" class="mb-4">
                    <label class="form-label d-block mb-2">Resursi</label>
                    <div class="d-flex flex-wrap gap-2">
                        @{
                            var povezaniResursi = (Model.Resursi ?? new List<MojAtar.Core.DTO.RadnjaResursDTO>())
                            .ToDictionary(r => r.IdResurs, r => r.Kolicina);

                        }

                        @foreach (var resurs in (IEnumerable<SelectListItem>)ViewBag.ResursiSelectList)
                        {
                            var isChecked = povezaniResursi.ContainsKey(Guid.Parse(resurs.Value));
                            <div class="form-check resurs-card shadow-sm">
                                <input class="form-check-input resurs-checkbox" type="checkbox"
                                       id="resursCheckbox_@resurs.Value" value="@resurs.Value" data-naziv="@resurs.Text"
                                       @(isChecked ? "checked" : "") />
                                <label class="form-check-label fw-semibold" for="resursCheckbox_@resurs.Value">
                                    @resurs.Text
                                </label>
                            </div>
                        }
                    </div>
                </div>


                <div id="resursDetaljiContainer">
                    @{
                        int indexResurs = 0;
                    }
                    @foreach (var resurs in (IEnumerable<SelectListItem>)ViewBag.ResursiSelectList)
                    {
                        var isChecked = povezaniResursi.ContainsKey(Guid.Parse(resurs.Value));
                        if (isChecked)
                        {
                            var resData = povezaniResursi[Guid.Parse(resurs.Value)];

                            <div class="mb-3" id="unos-resurs-@resurs.Value" style="display: block;">
                                <label class="form-label">Resurs: @resurs.Text – količina</label>
                                <input type="number" name="Resursi[@indexResurs].Kolicina"
                                       class="form-control mb-2 resurs-kolicina-input"
                                       step="0.1" min="0" value="@resData" required />
                                <input type="hidden" name="Resursi[@indexResurs].IdResurs" value="@resurs.Value" />
                            </div>
                            indexResurs++;
                        }
                    }
                </div>

                <div id="ukupanTrosakPrikaz" class="mt-3">
                    <strong>
                        Ukupan trošak:
                        <span id="ukupanTrosak">
                            @(Model.Id != null ? Model.UkupanTrosak.ToString("0.00") : "0.00")
                        </span> RSD
                    </strong>
                </div>

                <input type="hidden" name="UkupanTrosak" value="@(Model.Id != null ? Model.UkupanTrosak.ToString("0.00") : "0.00")" />

                <button type="submit" class="btn btn-success mt-3">Sačuvaj</button>
            </form>
        }
        
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // --- KONSTANTE I ELEMENTI ---
            const tipRadnjeSelect = document.getElementById("TipRadnje");
            const prinosDiv = document.getElementById("prinosDiv");
            const TIP_SETVA = @((int)MojAtar.Core.Domain.Enums.RadnjaTip.Setva);
            const TIP_ZETVA = @((int)MojAtar.Core.Domain.Enums.RadnjaTip.Zetva);

            // =========================================================
            // 1. LOGIKA ZA PRIKAZ POLJA POVRŠINE (SETVA) I PRINOSA (ŽETVA)
            // =========================================================
            function azurirajPrikazPolja() {
                const tip = parseInt(tipRadnjeSelect.value);
                const isSetva = (tip === TIP_SETVA);
                const isZetva = (tip === TIP_ZETVA);

                // A) Upravljanje poljima za površinu unutar svake parcele
                document.querySelectorAll('.parcela-row').forEach(row => {
                    // Pronađi elemente unutar ovog reda
                    const wrapper = row.querySelector('.p-povrsina-wrapper');
                    const input = row.querySelector('.p-povrsina-input');
                    const pId = row.id.replace('unos-parcela-', ''); // vadimo GUID
                    const slobodnaLbl = document.getElementById(`lbl-slobodno-${pId}`);

                    // Ako je red vidljiv (parcela selektovana), primeni logiku setve
                    if (row.style.display !== 'none') {
                        if (isSetva) {
                            wrapper.style.display = "block";
                            input.disabled = false; // Mora biti enabled da bi se poslao

                            // Učitaj slobodnu površinu ako već nije učitana
                            dohvatiSlobodnuPovrsinu(pId, slobodnaLbl);
                        } else {
                            wrapper.style.display = "none";
                            input.disabled = true; // Onemogući da ne šalje null/0 bezveze
                            if(slobodnaLbl) slobodnaLbl.textContent = "";
                        }
                    }
                });

                // B) Upravljanje poljem za Prinos (Žetva)
                if (prinosDiv) {
                    if (isZetva) {
                        prinosDiv.style.display = "block";
                        const pInput = document.getElementById("Prinos");
                        if(pInput) pInput.disabled = false;
                    } else {
                        prinosDiv.style.display = "none";
                        const pInput = document.getElementById("Prinos");
                        if(pInput) pInput.disabled = true;
                    }
                }
            }

            // AJAX funkcija za slobodnu površinu
            async function dohvatiSlobodnuPovrsinu(id, labelElement) {
                if(!id || !labelElement) return;
                if(labelElement.textContent.includes("Slobodno") || labelElement.textContent.includes("Greška")) return; // Ne zovi ponovo

                labelElement.textContent = "Računam...";
                try {
                    const response = await fetch(`/radnje/slobodnaPovrsina/${id}`);
                    if (response.ok) {
                        const data = await response.json();
                        labelElement.textContent = `Slobodno za setvu: ${data.slobodno.toFixed(4)} ha`;
                    } else {
                        labelElement.textContent = "";
                    }
                } catch {
                    labelElement.textContent = "";
                }
            }

            // Event listener za promenu tipa radnje
            if (tipRadnjeSelect) {
                tipRadnjeSelect.addEventListener("change", azurirajPrikazPolja);
            }

            // =========================================================
            // 2. LOGIKA ZA ODABIR PARCELA (CHECKBOX KARTICE)
            // =========================================================
            document.querySelectorAll('.parcela-checkbox').forEach(chk => {
                chk.addEventListener('change', function() {
                    const pId = this.value;
                    // Pronađi odgovarajući div za unos detalja (on je već u HTML-u)
                    const detaljiRow = document.getElementById(`unos-parcela-${pId}`);

                    if (!detaljiRow) return;

                    if (this.checked) {
                        // Prikaži red
                        detaljiRow.style.display = "block";

                        // Enable-uj ID parcele (obavezno!)
                        const idInput = detaljiRow.querySelector('.p-id-input');
                        if(idInput) idInput.disabled = false;

                        // Proveri da li treba prikazati površinu (ako je Setva)
                        azurirajPrikazPolja();
                    } else {
                        // Sakrij red
                        detaljiRow.style.display = "none";

                        // Disable-uj sve inpute unutra da se ne šalju na server
                        detaljiRow.querySelectorAll('input').forEach(input => input.disabled = true);
                    }
                });
            });


            // =========================================================
            // 3. LOGIKA ZA MAŠINE I RESURSE (Ovo je tvoj stari kod, malo sređen)
            // =========================================================

            // --- RADNE MAŠINE ---
            let masineBrojac = document.querySelectorAll('#masineDetaljiContainer input[name^="RadneMasine["]').length;
            const masineMap = new Map();
            // Inicijalno mapiranje postojećih
            document.querySelectorAll('.masina-checkbox:checked').forEach(checkbox => {
                 const id = checkbox.value;
                 if(!masineMap.has(id)) masineMap.set(id, masineBrojac++); // samo da ne pucaju indexi
            });

            document.querySelectorAll('.masina-checkbox').forEach(chk => {
                chk.addEventListener('change', function() {
                    const id = this.value;
                    const naziv = this.getAttribute('data-naziv');
                    const container = document.getElementById("masineDetaljiContainer");
                    let existing = document.getElementById(`unos-masina-${id}`);

                    if(this.checked) {
                        if(existing) {
                            existing.style.display = "block";
                            existing.querySelectorAll("input").forEach(i => i.disabled = false);
                        } else {
                            const index = masineBrojac++;
                            masineMap.set(id, index);
                            const div = document.createElement("div");
                            div.className = "mb-3";
                            div.id = `unos-masina-${id}`;
                            div.innerHTML = `
                                <label class="form-label">Radna mašina: ${naziv} – broj sati</label>
                                <input type="hidden" name="RadneMasine[${index}].IdRadnaMasina" value="${id}" />
                                <input type="number" name="RadneMasine[${index}].BrojRadnihSati" class="form-control" step="1" min="1" required />
                            `;
                            container.appendChild(div);
                        }
                        // Brisanje iz liste za brisanje
                        const removed = document.getElementById(`obrisana-masina-${id}`);
                        if(removed) removed.remove();
                    } else {
                        if(existing) {
                            existing.style.display = "none";
                            existing.querySelectorAll("input").forEach(i => i.disabled = true);

                            // Dodaj u listu za brisanje
                            const delCont = document.getElementById("obrisaneMasineContainer");
                            if(delCont && !document.getElementById(`obrisana-masina-${id}`)) {
                                const hid = document.createElement("input");
                                hid.type="hidden"; hid.name="ObrisaneRadneMasineId[]"; hid.value=id; hid.id=`obrisana-masina-${id}`;
                                delCont.appendChild(hid);
                            }
                        }
                    }
                });
            });

            // --- PRIKLJUČNE MAŠINE ---
            let prikBrojac = document.querySelectorAll('#prikljucneDetaljiContainer input[name^="PrikljucneMasine["]').length;

            document.querySelectorAll('.prikljucna-checkbox').forEach(chk => {
                chk.addEventListener('change', function() {
                    const id = this.value;
                    const container = document.getElementById("prikljucneDetaljiContainer");
                    const existing = document.getElementById(`unos-prikljucna-${id}`);

                    if(this.checked) {
                        if(!existing) {
                            const input = document.createElement("input");
                            input.type = "hidden";
                            input.name = `PrikljucneMasine[${prikBrojac++}].IdPrikljucnaMasina`;
                            input.id = `unos-prikljucna-${id}`;
                            input.value = id;
                            container.appendChild(input);
                        }
                        const removed = document.getElementById(`obrisana-prikljucna-${id}`);
                        if(removed) removed.remove();
                    } else {
                        if(existing) existing.remove();
                         const delCont = document.getElementById("obrisanePrikljucneContainer");
                         if(delCont && !document.getElementById(`obrisana-prikljucna-${id}`)) {
                             const hid = document.createElement("input");
                             hid.type="hidden"; hid.name="ObrisanePrikljucneMasineId[]"; hid.value=id; hid.id=`obrisana-prikljucna-${id}`;
                             delCont.appendChild(hid);
                         }
                    }
                });
            });

            // --- RESURSI I TROŠKOVI ---
            const ceneResursa = @Html.Raw(Json.Serialize(ViewBag.CeneResursa));
            let resursBrojac = @(Model.Resursi?.Count ?? 0);

            function izracunajUkupanTrosak() {
                let ukupno = 0;
                document.querySelectorAll('.resurs-kolicina-input').forEach(inp => {
                    if(!inp.disabled) {
                        const val = parseFloat(inp.value) || 0;
                        const parent = inp.closest('div[id^="unos-resurs-"]');
                        if(parent) {
                            const rId = parent.id.replace('unos-resurs-', '');
                            const cena = parseFloat(ceneResursa[rId]) || 0;
                            ukupno += val * cena;
                        }
                    }
                });
                document.getElementById("ukupanTrosak").innerText = ukupno.toFixed(2);
                const hidTotal = document.querySelector('input[name="UkupanTrosak"]');
                if(hidTotal) hidTotal.value = ukupno.toFixed(2);
            }

            // Listener za promene količine
            const resursContainer = document.getElementById("resursDetaljiContainer");
            if(resursContainer) {
                resursContainer.addEventListener('input', function(e) {
                    if(e.target.classList.contains('resurs-kolicina-input')) izracunajUkupanTrosak();
                });
            }

            document.querySelectorAll('.resurs-checkbox').forEach(chk => {
                chk.addEventListener('change', function() {
                    const id = this.value;
                    const naziv = this.getAttribute('data-naziv');
                    let existing = document.getElementById(`unos-resurs-${id}`);
                    const delCont = document.getElementById("obrisaniResursiContainer");

                    if(this.checked) {
                        if(existing) {
                            existing.style.display = "block";
                            existing.querySelectorAll("input").forEach(i => i.disabled = false);
                        } else {
                            existing = document.createElement("div");
                            existing.className = "mb-3";
                            existing.id = `unos-resurs-${id}`;
                            const idx = resursBrojac++;
                            existing.innerHTML = `
                                <label class="form-label">Resurs: ${naziv} – količina</label>
                                <input type="hidden" name="Resursi[${idx}].IdResurs" value="${id}" />
                                <input type="number" name="Resursi[${idx}].Kolicina" class="form-control mb-2 resurs-kolicina-input" step="0.1" min="0" required />
                            `;
                            resursContainer.appendChild(existing);
                        }
                        const removed = document.getElementById(`obrisan-resurs-${id}`);
                        if(removed) removed.remove();
                    } else {
                         if(existing) {
                            existing.style.display = "none";
                            existing.querySelectorAll("input").forEach(i => i.disabled = true);
                        }
                        if(delCont && !document.getElementById(`obrisan-resurs-${id}`)) {
                             const hid = document.createElement("input");
                             hid.type="hidden"; hid.name="ObrisaniResursiId[]"; hid.value=id; hid.id=`obrisan-resurs-${id}`;
                             delCont.appendChild(hid);
                        }
                    }
                    izracunajUkupanTrosak();
                });
            });

            // Inicijalni pozivi
            azurirajPrikazPolja();
            izracunajUkupanTrosak();


            // =========================================================
            // 4. KLIJENTSKA VALIDACIJA (Ažurirana za parcele)
            // =========================================================
            document.querySelector("form").addEventListener("submit", function (e) {
                let valid = true;
                const tipRadnje = parseInt(document.getElementById("TipRadnje")?.value);

                // Reset errors
                document.querySelectorAll(".is-invalid").forEach(i => i.classList.remove("is-invalid"));

                // A) Validacija Parcela
                // Mora biti bar jedna parcela selektovana
                const selektovaneParcele = document.querySelectorAll('.parcela-checkbox:checked');
                if (selektovaneParcele.length === 0) {
                    alert("Morate izabrati barem jednu parcelu.");
                    valid = false;
                }

                // Ako je SETVA, svaka selektovana parcela mora imati unetu površinu
                if (tipRadnje === TIP_SETVA) {
                    selektovaneParcele.forEach(chk => {
                        const pId = chk.value;
                        const row = document.getElementById(`unos-parcela-${pId}`);
                        const inputPovrsina = row.querySelector('.p-povrsina-input');

                        if (!inputPovrsina.value || parseFloat(inputPovrsina.value) <= 0) {
                            inputPovrsina.classList.add("is-invalid");
                            valid = false;
                        }
                    });
                }

                // B) Validacija Žetve (Prinos)
                if (tipRadnje === TIP_ZETVA) {
                    const prinos = document.querySelector("[name='Prinos']");
                    if (!prinos.value || parseFloat(prinos.value) <= 0) {
                        prinos.classList.add("is-invalid");
                        valid = false;
                    }
                }

                // C) Validacija Mašina (Sati)
                document.querySelectorAll('.masina-checkbox:checked').forEach(chk => {
                    const id = chk.value;
                    const input = document.querySelector(`#unos-masina-${id} input[name*='BrojRadnihSati']`);
                    if (input && (!input.value || parseFloat(input.value) <= 0)) {
                        input.classList.add("is-invalid");
                        valid = false;
                    }
                });

                // D) Validacija Resursa (Količina)
                document.querySelectorAll('.resurs-checkbox:checked').forEach(chk => {
                    const id = chk.value;
                    const input = document.querySelector(`#unos-resurs-${id} input[name*='Kolicina']`);
                    if (input && (!input.value || parseFloat(input.value) <= 0)) {
                        input.classList.add("is-invalid");
                        valid = false;
                    }
                });

                if (!valid) {
                    e.preventDefault();
                    // alert("Proverite unete podatke."); // Opciono
                }
            });
        });
    </script>
}
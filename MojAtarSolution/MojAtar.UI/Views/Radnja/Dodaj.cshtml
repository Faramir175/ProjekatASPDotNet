@model MojAtar.Core.DTO.RadnjaDTO
@using Newtonsoft.Json

@{
    ViewData["Title"] = "Dodaj / Izmeni Radnju";
}

@if (!ViewData.ModelState.IsValid)
{
    foreach (var modelError in ViewData.ModelState.Values.SelectMany(v => v.Errors))
    {
        <div class="alert alert-danger">@modelError.ErrorMessage</div>
    }
}

<div class="container py-5">
    @if (ViewBag.ErrorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            @ViewBag.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Zatvori"></button>
        </div>
    }

    <div class="container-glass">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>@(Model.Id == null ? "Dodaj Radnju" : "Izmeni Radnju")</h2>

            @if (Model.IdParcela != null)
            {
                <a asp-action="RadnjePoParceli" asp-route-idParcela="@Model.IdParcela" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Nazad
                </a>
            }
            else
            {
                <a asp-action="Radnje" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Nazad
                </a>
            }
        </div>

        @if (ViewBag.SetvaZakljucana == true)
        {
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle"></i>
                Ova setva je <strong>zaključana</strong> jer je za nju već obavljena žetva.
                Možete pregledati podatke, ali izmene nisu dozvoljene.
            </div>
        }

        @if (ViewBag.SetvaZakljucana == true)
        {
            <fieldset disabled style="opacity:0.85;">
                <form method="post" asp-action="@(Model.Id == null ? "Dodaj" : "Izmeni")" asp-controller="Radnja">
                    @if (Model.Id != null)
                    {
                        <input type="hidden" asp-for="Id" />
                    }
                    <div id="obrisaneMasineContainer"></div>
                    <div id="obrisanePrikljucneContainer"></div>
                    <div id="obrisaniResursiContainer"></div>

                    @if (Model.Id == null)
                    {
                        <div class="mb-3">
                            <label class="form-label" for="IdParcela">Parcela</label>
                            <select asp-for="IdParcela" class="form-control" asp-items="ViewBag.ParceleSelectList" id="parcelaSelect">
                                <option value="">-- Izaberite parcelu --</option>
                            </select>
                            <span asp-validation-for="IdParcela" class="text-danger"></span>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label class="form-label" for="IdParcela">Parcela</label>
                            <select asp-for="IdParcela" class="form-control" asp-items="ViewBag.ParceleSelectList" disabled>
                                <option value="">-- Izaberite parcelu --</option>
                            </select>
                            <input type="hidden" asp-for="IdParcela" />
                            <span asp-validation-for="IdParcela" class="text-danger"></span>
                            <small class="text-muted">Parcela se ne može menjati nakon kreiranja radnje.</small>
                        </div>
                    }

                    @if (Model.Id == null)
                    {
                        <div class="mb-3">
                            <label asp-for="DatumIzvrsenja" class="form-label">Datum izvršenja</label>
                            <input asp-for="DatumIzvrsenja" class="form-control" type="date" />
                            <span asp-validation-for="DatumIzvrsenja" class="text-danger"></span>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label asp-for="DatumIzvrsenja" class="form-label">Datum izvršenja</label>
                            <input asp-for="DatumIzvrsenja" class="form-control" type="date" readonly />
                            <span asp-validation-for="DatumIzvrsenja" class="text-danger"></span>
                            <small class="text-muted">Datum izvršenja se ne može menjati nakon unosa radnje.</small>
                        </div>
                    }


                    @if (Model.Id == null)
                    {
                        <div class="mb-3">
                            <label asp-for="TipRadnje" class="form-label">Tip radnje</label>
                            <select asp-for="TipRadnje" class="form-control" asp-items="Html.GetEnumSelectList<MojAtar.Core.Domain.Enums.RadnjaTip>()"></select>
                            <span asp-validation-for="TipRadnje" class="text-danger"></span>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label>Tip radnje</label>
                            <select asp-for="TipRadnje" class="form-control" disabled id="TipRadnje">
                                <option value="@Model.TipRadnje" selected>@Model.TipRadnje</option>
                            </select>
                            <span asp-validation-for="TipRadnje" class="text-danger"></span>
                            <input type="hidden" asp-for="TipRadnje" />
                        </div>
                    }

                    <div class="mb-3">
                        <label asp-for="Napomena" class="form-label">Napomena</label>
                        <textarea asp-for="Napomena" class="form-control" rows="4" style="min-height: 120px; resize: vertical;"></textarea>
                        <small class="text-muted">Unesi dodatne detalje o radnji (opciono).</small>
                    </div>


                    <div class="mb-3">
                        <label for="IdKultura">Kultura</label>
                        <select asp-for="IdKultura" class="form-control" asp-items="ViewBag.KultureSelectList">
                            <option value="">-- Izaberite kulturu --</option>
                        </select>
                    </div>

                    <div class="mb-3" id="povrsinaDiv" style="display:@(Model.TipRadnje == MojAtar.Core.Domain.Enums.RadnjaTip.Setva ? "block" : "none")">
                        <label asp-for="Povrsina" class="form-label">Površina za setvu (ha)</label>
                        <input asp-for="Povrsina" class="form-control" type="number" step="0.0001" min="0.0001" />
                        <span asp-validation-for="Povrsina" class="text-danger"></span>
                        <small id="slobodnaPovrsinaLabel" class="text-muted d-block mt-1">
                            Dostupna površina: -
                        </small>
                    </div>


                    <div class="mb-3" id="prinosDiv" style="display:@(Model.TipRadnje == MojAtar.Core.Domain.Enums.RadnjaTip.Zetva ? "block" : "none")">
                        <label asp-for="Prinos" class="form-label">Prinos (kg)</label>
                        <input asp-for="Prinos" class="form-control" type="number" step="0.01" />
                        <span asp-validation-for="Prinos" class="text-danger"></span>
                    </div>

                    <div id="listaMasina" class="mb-4">
                        <label class="form-label d-block mb-2">Radne mašine</label>

                        <!-- kartice -->
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            @{
                                var povezaneMasine = Model.RadneMasine?.ToDictionary(rm => rm.IdRadnaMasina, rm => (double)rm.BrojRadnihSati)
                                ?? new Dictionary<Guid, double>();
                                int index = 0;
                            }

                            @foreach (var masina in (IEnumerable<SelectListItem>)ViewBag.RadneMasineSelectList)
                            {
                                var isChecked = povezaneMasine.ContainsKey(Guid.Parse(masina.Value));
                                <div class="form-check masina-card shadow-sm">
                                    <input class="form-check-input masina-checkbox" type="checkbox"
                                           id="masinaCheckbox_@masina.Value" value="@masina.Value" data-naziv="@masina.Text"
                                           @(isChecked ? "checked" : "") />
                                    <label class="form-check-label fw-semibold" for="masinaCheckbox_@masina.Value">
                                        @masina.Text
                                    </label>
                                </div>
                            }
                        </div>

                        <!-- ✅ ispod kartica prikaz broja sati -->
                        <div id="masineDetaljiContainer">
                            @foreach (var masina in (IEnumerable<SelectListItem>)ViewBag.RadneMasineSelectList)
                            {
                                var isChecked = povezaneMasine.ContainsKey(Guid.Parse(masina.Value));
                                if (isChecked)
                                {
                                    <div class="mb-3" id="unos-masina-@masina.Value">
                                        <label class="form-label">Radna mašina: @masina.Text – broj sati</label>
                                        <input type="hidden" name="RadneMasine[@index].IdRadnaMasina" value="@masina.Value" />
                                        <input type="number" name="RadneMasine[@index].BrojRadnihSati"
                                               class="form-control" step="1" min="1"
                                               value="@povezaneMasine[Guid.Parse(masina.Value)]" required />
                                    </div>
                                    index++;
                                }
                            }
                        </div>
                    </div>



                    <div id="listaPrikljucnihMasina" class="mb-4">
                        <label class="form-label d-block mb-2">Priključne mašine</label>
                        <div class="d-flex flex-wrap gap-2">
                            @{
                                var povezanePrikljucne = Model.PrikljucneMasine?
                                .Select(pm => pm.IdPrikljucnaMasina)
                                .ToHashSet()
                                ?? new HashSet<Guid>();
                                int indexPrik = 0;
                            }

                            @foreach (var masina in (IEnumerable<SelectListItem>)ViewBag.PrikljucneMasineSelectList)
                            {
                                var isChecked = povezanePrikljucne.Contains(Guid.Parse(masina.Value));
                                <div class="form-check prikljucna-card shadow-sm">
                                    <input class="form-check-input prikljucna-checkbox" type="checkbox"
                                           id="prikljucnaCheckbox_@masina.Value" value="@masina.Value" data-naziv="@masina.Text"
                                           @(isChecked ? "checked" : "") />
                                    <label class="form-check-label fw-semibold" for="prikljucnaCheckbox_@masina.Value">
                                        @masina.Text
                                    </label>
                                </div>

                                if (isChecked)
                                {
                                    <input type="hidden" name="PrikljucneMasine[@indexPrik].IdPrikljucnaMasina" value="@masina.Value" />
                                    indexPrik++;
                                }
                            }
                        </div>
                    </div>


                    <div id="prikljucneDetaljiContainer"></div>

                    <div id="listaResursa" class="mb-4">
                        <label class="form-label d-block mb-2">Resursi</label>
                        <div class="d-flex flex-wrap gap-2">
                            @{
                                var povezaniResursi = (Model.Resursi ?? new List<MojAtar.Core.DTO.RadnjaResursDTO>())
                                .ToDictionary(r => r.IdResurs, r => r.Kolicina);

                            }

                            @foreach (var resurs in (IEnumerable<SelectListItem>)ViewBag.ResursiSelectList)
                            {
                                var isChecked = povezaniResursi.ContainsKey(Guid.Parse(resurs.Value));
                                <div class="form-check resurs-card shadow-sm">
                                    <input class="form-check-input resurs-checkbox" type="checkbox"
                                           id="resursCheckbox_@resurs.Value" value="@resurs.Value" data-naziv="@resurs.Text"
                                           @(isChecked ? "checked" : "") />
                                    <label class="form-check-label fw-semibold" for="resursCheckbox_@resurs.Value">
                                        @resurs.Text
                                    </label>
                                </div>
                            }
                        </div>
                    </div>


                    <div id="resursDetaljiContainer">
                        @{
                            int indexResurs = 0;
                        }
                        @foreach (var resurs in (IEnumerable<SelectListItem>)ViewBag.ResursiSelectList)
                        {
                            var isChecked = povezaniResursi.ContainsKey(Guid.Parse(resurs.Value));
                            if (isChecked)
                            {
                                var resData = povezaniResursi[Guid.Parse(resurs.Value)];

                                <div class="mb-3" id="unos-resurs-@resurs.Value" style="display: block;">
                                    <label class="form-label">Resurs: @resurs.Text – količina</label>
                                    <input type="number" name="Resursi[@indexResurs].Kolicina"
                                           class="form-control mb-2 resurs-kolicina-input"
                                           step="0.1" min="0" value="@resData" required />
                                    <input type="hidden" name="Resursi[@indexResurs].IdResurs" value="@resurs.Value" />
                                </div>
                                indexResurs++;
                            }
                        }
                    </div>

                    <div id="ukupanTrosakPrikaz" class="mt-3">
                        <strong>
                            Ukupan trošak:
                            <span id="ukupanTrosak">
                                @(Model.Id != null ? Model.UkupanTrosak.ToString("0.00") : "0.00")
                            </span> RSD
                        </strong>
                    </div>

                    <input type="hidden" name="UkupanTrosak" value="@(Model.Id != null ? Model.UkupanTrosak.ToString("0.00") : "0.00")" />

                    <button type="submit" class="btn btn-success mt-3">Sačuvaj</button>
                </form>
            </fieldset>
        }
        else
        {
            <form method="post" asp-action="@(Model.Id == null ? "Dodaj" : "Izmeni")" asp-controller="Radnja">
                @if (Model.Id != null)
                {
                    <input type="hidden" asp-for="Id" />
                }
                <div id="obrisaneMasineContainer"></div>
                <div id="obrisanePrikljucneContainer"></div>
                <div id="obrisaniResursiContainer"></div>

                @if (Model.Id == null)
                {
                    <div class="mb-3">
                        <label class="form-label" for="IdParcela">Parcela</label>
                        <select asp-for="IdParcela" class="form-control" asp-items="ViewBag.ParceleSelectList" id="parcelaSelect">
                            <option value="">-- Izaberite parcelu --</option>
                        </select>
                        <span asp-validation-for="IdParcela" class="text-danger"></span>
                    </div>
                }
                else
                {
                    <div class="mb-3">
                        <label class="form-label" for="IdParcela">Parcela</label>
                        <select asp-for="IdParcela" class="form-control" asp-items="ViewBag.ParceleSelectList" disabled>
                            <option value="">-- Izaberite parcelu --</option>
                        </select>
                        <input type="hidden" asp-for="IdParcela" />
                        <span asp-validation-for="IdParcela" class="text-danger"></span>
                        <small class="text-muted">Parcela se ne može menjati nakon kreiranja radnje.</small>
                    </div>
                }

                @if (Model.Id == null)
                {
                    <div class="mb-3">
                        <label asp-for="DatumIzvrsenja" class="form-label">Datum izvršenja</label>
                        <input asp-for="DatumIzvrsenja" class="form-control" type="date" />
                        <span asp-validation-for="DatumIzvrsenja" class="text-danger"></span>
                    </div>
                }
                else
                {
                    <div class="mb-3">
                        <label asp-for="DatumIzvrsenja" class="form-label">Datum izvršenja</label>
                        <input asp-for="DatumIzvrsenja" class="form-control" type="date" readonly />
                        <span asp-validation-for="DatumIzvrsenja" class="text-danger"></span>
                        <small class="text-muted">Datum izvršenja se ne može menjati nakon unosa radnje.</small>
                    </div>
                }


                @if (Model.Id == null)
                {
                    <div class="mb-3">
                        <label asp-for="TipRadnje" class="form-label">Tip radnje</label>
                        <select asp-for="TipRadnje" class="form-control" asp-items="Html.GetEnumSelectList<MojAtar.Core.Domain.Enums.RadnjaTip>()"></select>
                        <span asp-validation-for="TipRadnje" class="text-danger"></span>
                    </div>
                }
                else
                {
                    <div class="mb-3">
                        <label>Tip radnje</label>
                        <select asp-for="TipRadnje" class="form-control" disabled id="TipRadnje">
                            <option value="@Model.TipRadnje" selected>@Model.TipRadnje</option>
                        </select>
                        <span asp-validation-for="TipRadnje" class="text-danger"></span>
                        <input type="hidden" asp-for="TipRadnje" />
                    </div>
                }

                <div class="mb-3">
                    <label asp-for="Napomena" class="form-label">Napomena</label>
                    <textarea asp-for="Napomena" class="form-control" rows="4" style="min-height: 120px; resize: vertical;"></textarea>
                    <small class="text-muted">Unesi dodatne detalje o radnji (opciono).</small>
                </div>


                <div class="mb-3">
                    <label for="IdKultura">Kultura</label>
                    <select asp-for="IdKultura" class="form-control" asp-items="ViewBag.KultureSelectList">
                        <option value="">-- Izaberite kulturu --</option>
                    </select>
                </div>

                <div class="mb-3" id="povrsinaDiv" style="display:@(Model.TipRadnje == MojAtar.Core.Domain.Enums.RadnjaTip.Setva ? "block" : "none")">
                    <label asp-for="Povrsina" class="form-label">Površina za setvu (ha)</label>
                    <input asp-for="Povrsina" class="form-control" type="number" step="0.0001" min="0.0001" />
                    <span asp-validation-for="Povrsina" class="text-danger"></span>
                    <small id="slobodnaPovrsinaLabel" class="text-muted d-block mt-1">
                        Dostupna površina: -
                    </small>
                </div>


                <div class="mb-3" id="prinosDiv" style="display:@(Model.TipRadnje == MojAtar.Core.Domain.Enums.RadnjaTip.Zetva ? "block" : "none")">
                    <label asp-for="Prinos" class="form-label">Prinos (kg)</label>
                    <input asp-for="Prinos" class="form-control" type="number" step="0.01" />
                    <span asp-validation-for="Prinos" class="text-danger"></span>
                </div>

                <div id="listaMasina" class="mb-4">
                    <label class="form-label d-block mb-2">Radne mašine</label>

                    <!-- kartice -->
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        @{
                            var povezaneMasine = Model.RadneMasine?.ToDictionary(rm => rm.IdRadnaMasina, rm => (double)rm.BrojRadnihSati)
                            ?? new Dictionary<Guid, double>();
                            int index = 0;
                        }

                        @foreach (var masina in (IEnumerable<SelectListItem>)ViewBag.RadneMasineSelectList)
                        {
                            var isChecked = povezaneMasine.ContainsKey(Guid.Parse(masina.Value));
                            <div class="form-check masina-card shadow-sm">
                                <input class="form-check-input masina-checkbox" type="checkbox"
                                       id="masinaCheckbox_@masina.Value" value="@masina.Value" data-naziv="@masina.Text"
                                       @(isChecked ? "checked" : "") />
                                <label class="form-check-label fw-semibold" for="masinaCheckbox_@masina.Value">
                                    @masina.Text
                                </label>
                            </div>
                        }
                    </div>

                    <!-- ✅ ispod kartica prikaz broja sati -->
                    <div id="masineDetaljiContainer">
                        @foreach (var masina in (IEnumerable<SelectListItem>)ViewBag.RadneMasineSelectList)
                        {
                            var isChecked = povezaneMasine.ContainsKey(Guid.Parse(masina.Value));
                            if (isChecked)
                            {
                                <div class="mb-3" id="unos-masina-@masina.Value">
                                    <label class="form-label">Radna mašina: @masina.Text – broj sati</label>
                                    <input type="hidden" name="RadneMasine[@index].IdRadnaMasina" value="@masina.Value" />
                                    <input type="number" name="RadneMasine[@index].BrojRadnihSati"
                                           class="form-control" step="1" min="1"
                                           value="@povezaneMasine[Guid.Parse(masina.Value)]" required />
                                </div>
                                index++;
                            }
                        }
                    </div>
                </div>

                <div id="listaPrikljucnihMasina" class="mb-4">
                    <label class="form-label d-block mb-2">Priključne mašine</label>
                    <div class="d-flex flex-wrap gap-2">
                        @{
                            var povezanePrikljucne = Model.PrikljucneMasine?
                            .Select(pm => pm.IdPrikljucnaMasina)
                            .ToHashSet()
                            ?? new HashSet<Guid>();
                            int indexPrik = 0;
                        }

                        @foreach (var masina in (IEnumerable<SelectListItem>)ViewBag.PrikljucneMasineSelectList)
                        {
                            var isChecked = povezanePrikljucne.Contains(Guid.Parse(masina.Value));
                            <div class="form-check prikljucna-card shadow-sm">
                                <input class="form-check-input prikljucna-checkbox" type="checkbox"
                                       id="prikljucnaCheckbox_@masina.Value" value="@masina.Value" data-naziv="@masina.Text"
                                       @(isChecked ? "checked" : "") />
                                <label class="form-check-label fw-semibold" for="prikljucnaCheckbox_@masina.Value">
                                    @masina.Text
                                </label>
                            </div>

                            if (isChecked)
                            {
                                <input type="hidden" name="PrikljucneMasine[@indexPrik].IdPrikljucnaMasina" value="@masina.Value" />
                                indexPrik++;
                            }
                        }
                    </div>
                </div>


                <div id="prikljucneDetaljiContainer"></div>

                <div id="listaResursa" class="mb-4">
                    <label class="form-label d-block mb-2">Resursi</label>
                    <div class="d-flex flex-wrap gap-2">
                        @{
                            var povezaniResursi = (Model.Resursi ?? new List<MojAtar.Core.DTO.RadnjaResursDTO>())
                            .ToDictionary(r => r.IdResurs, r => r.Kolicina);

                        }

                        @foreach (var resurs in (IEnumerable<SelectListItem>)ViewBag.ResursiSelectList)
                        {
                            var isChecked = povezaniResursi.ContainsKey(Guid.Parse(resurs.Value));
                            <div class="form-check resurs-card shadow-sm">
                                <input class="form-check-input resurs-checkbox" type="checkbox"
                                       id="resursCheckbox_@resurs.Value" value="@resurs.Value" data-naziv="@resurs.Text"
                                       @(isChecked ? "checked" : "") />
                                <label class="form-check-label fw-semibold" for="resursCheckbox_@resurs.Value">
                                    @resurs.Text
                                </label>
                            </div>
                        }
                    </div>
                </div>


                <div id="resursDetaljiContainer">
                    @{
                        int indexResurs = 0;
                    }
                    @foreach (var resurs in (IEnumerable<SelectListItem>)ViewBag.ResursiSelectList)
                    {
                        var isChecked = povezaniResursi.ContainsKey(Guid.Parse(resurs.Value));
                        if (isChecked)
                        {
                            var resData = povezaniResursi[Guid.Parse(resurs.Value)];

                            <div class="mb-3" id="unos-resurs-@resurs.Value" style="display: block;">
                                <label class="form-label">Resurs: @resurs.Text – količina</label>
                                <input type="number" name="Resursi[@indexResurs].Kolicina"
                                       class="form-control mb-2 resurs-kolicina-input"
                                       step="0.1" min="0" value="@resData" required />
                                <input type="hidden" name="Resursi[@indexResurs].IdResurs" value="@resurs.Value" />
                            </div>
                            indexResurs++;
                        }
                    }
                </div>

                <div id="ukupanTrosakPrikaz" class="mt-3">
                    <strong>
                        Ukupan trošak:
                        <span id="ukupanTrosak">
                            @(Model.Id != null ? Model.UkupanTrosak.ToString("0.00") : "0.00")
                        </span> RSD
                    </strong>
                </div>

                <input type="hidden" name="UkupanTrosak" value="@(Model.Id != null ? Model.UkupanTrosak.ToString("0.00") : "0.00")" />

                <button type="submit" class="btn btn-success mt-3">Sačuvaj</button>
            </form>
        }
        
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
                const tipRadnjeSelect = document.getElementById("TipRadnje");
                const prinosDiv = document.getElementById("prinosDiv");
                const povrsinaDiv = document.getElementById("povrsinaDiv");

                const SETVA_VALUE = "@((int)MojAtar.Core.Domain.Enums.RadnjaTip.Setva)";
                const ZETVA_VALUE = "@((int)MojAtar.Core.Domain.Enums.RadnjaTip.Zetva)";

                // Funkcija za Dodaj stranicu
                function toggleZetvaSetvaDodaj() {
                    if (tipRadnjeSelect) {
                        if (tipRadnjeSelect.value === SETVA_VALUE) {
                            povrsinaDiv.style.display = "block";
                            prinosDiv.style.display = "none";
                        } else if (tipRadnjeSelect.value === ZETVA_VALUE) {
                            povrsinaDiv.style.display = "none";
                            prinosDiv.style.display = "block";
                        } else {
                            povrsinaDiv.style.display = "none";
                            prinosDiv.style.display = "none";
                        }
                    }
                }

                // Funkcija za Izmeni stranicu
                function toggleZetvaSetvaIzmeni() {
                    if (tipRadnjeSelect) {
                        // Kod izmeni select je disabled, vrednost dolazi iz modela
                        const tipRadnje = "@((int)Model.TipRadnje)";
                        if (tipRadnje === SETVA_VALUE) {
                            povrsinaDiv.style.display = "block";
                            prinosDiv.style.display = "none";
                        } else if (tipRadnje === ZETVA_VALUE) {
                            povrsinaDiv.style.display = "none";
                            prinosDiv.style.display = "block";
                        } else {
                            povrsinaDiv.style.display = "none";
                            prinosDiv.style.display = "none";
                        }
                    }
                }

                // Pozivanje prema tipu stranice
                @if (Model.Id == null)
                {
                        <text>
                            tipRadnjeSelect?.addEventListener("change", toggleZetvaSetvaDodaj);
                            toggleZetvaSetvaDodaj();
                        </text>
                }
                else
                {
                        <text>
                            toggleZetvaSetvaIzmeni();
                        </text>
                }

            // RADNE MAŠINE (Your existing logic for machines is fine for showing/hiding)
            let masineBrojac = document.querySelectorAll('#masineDetaljiContainer input[name^="RadneMasine["]').length;
            const masineMap = new Map();

            document.querySelectorAll('.masina-checkbox:checked').forEach(checkbox => {
                const id = checkbox.value;
                const existingDiv = document.getElementById(`unos-masina-${id}`);
                if (existingDiv && !masineMap.has(id)) {
                    masineMap.set(id, masineBrojac++);
                }
            });

            document.querySelectorAll('.masina-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const id = this.value;
                    const naziv = this.getAttribute('data-naziv');
                    const container = document.getElementById("masineDetaljiContainer");
                    const existing = document.getElementById(`unos-masina-${id}`);

                    if (this.checked) {
                        if (existing) {
                            existing.style.display = "block";
                            existing.querySelectorAll("input").forEach(i => i.disabled = false);
                        } else {
                            const index = masineBrojac++;
                            masineMap.set(id, index);

                            const div = document.createElement("div");
                            div.classList.add("mb-3");
                            div.id = `unos-masina-${id}`;
                            div.innerHTML = `
                                        <label class="form-label">Radna mašina: ${naziv} – broj sati</label>
                                <input type="hidden" name="RadneMasine[${index}].IdRadnaMasina" value="${id}" />
                                <input type="number" name="RadneMasine[${index}].BrojRadnihSati" class="form-control" step="1" min="1" required />
                            `;
                            container.appendChild(div);
                        }
                        const removed = document.getElementById(`obrisana-masina-${id}`);
                        if (removed) removed.remove();
                    } else {
                        if (existing) {
                            existing.style.display = "none";
                            existing.querySelectorAll("input").forEach(i => i.disabled = true);

                            const deletedContainer = document.getElementById("obrisaneMasineContainer");
                            if (deletedContainer && !document.getElementById(`obrisana-masina-${id}`)) {
                                const hiddenInput = document.createElement("input");
                                hiddenInput.type = "hidden";
                                hiddenInput.name = "ObrisaneRadneMasineId[]";
                                hiddenInput.value = id;
                                hiddenInput.id = `obrisana-masina-${id}`;
                                deletedContainer.appendChild(hiddenInput);
                            }
                        }
                    }
                });
            });

            // PRIKLJUČNE MAŠINE (Your existing logic for machines is fine for showing/hiding)
            let prikljucneBrojac = document.querySelectorAll('#prikljucneDetaljiContainer input[name^="PrikljucneMasine["]').length;
            const prikljucneMap = new Map();

            document.querySelectorAll('.prikljucna-checkbox').forEach(checkbox => {
                const id = checkbox.value;
                const existing = document.getElementById(`unos-prikljucna-${id}`);
                if (existing && !prikljucneMap.has(id)) {
                    prikljucneMap.set(id, prikljucneBrojac++);
                }
            });

            document.querySelectorAll('.prikljucna-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const id = this.value;
                    const container = document.getElementById("prikljucneDetaljiContainer");
                    const existing = document.getElementById(`unos-prikljucna-${id}`);

                    if (this.checked) {
                        if (!document.getElementById(`unos-prikljucna-${id}`)) {
                            const input = document.createElement("input");
                            input.type = "hidden";
                            input.name = `PrikljucneMasine[${prikljucneBrojac}].IdPrikljucnaMasina`;
                            input.id = `unos-prikljucna-${id}`;
                            input.value = id; // Ensure value is set for the hidden input
                            container.appendChild(input);
                            prikljucneBrojac++; // Increment for new additions
                        }
                        const removed = document.getElementById(`obrisana-prikljucna-${id}`);
                        if (removed) removed.remove();
                    } else {
                        if (existing) {
                            existing.remove();
                            const deletedContainer = document.getElementById("obrisanePrikljucneContainer");
                            if (deletedContainer && !document.getElementById(`obrisana-prikljucna-${id}`)) {
                                const hiddenInput = document.createElement("input");
                                hiddenInput.type = "hidden";
                                hiddenInput.name = "ObrisanePrikljucneMasineId[]";
                                hiddenInput.value = id;
                                hiddenInput.id = `obrisana-prikljucna-${id}`;
                                deletedContainer.appendChild(hiddenInput);
                            }
                        }
                    }
                });
            });


            // ==================================================================
            // ISPRAVLJENA LOGIKA ZA RESURSE I IZRAČUNAVANJE TROŠKA
            // ==================================================================
            const ceneResursa = @Html.Raw(Json.Serialize(ViewBag.CeneResursa));
            const resursDetaljiContainer = document.getElementById("resursDetaljiContainer");

            // Brojač za indekse novih resursa, počinje od broja već postojećih
            let resursBrojac = @(Model.Resursi?.Count ?? 0);

            function izracunajUkupanTrosak() {
                let ukupno = 0;
                // Selektuj SVE inpute za količinu unutar kontejnera
                const sviKolicinaInputi = resursDetaljiContainer.querySelectorAll('.resurs-kolicina-input');

                sviKolicinaInputi.forEach(kolicinaInput => {
                    // Jednostavna i pouzdana provera: ako input NIJE onemogućen, dodaj u trošak
                    if (!kolicinaInput.disabled) {
                        const kolicina = parseFloat(kolicinaInput.value) || 0;
                        const parentDiv = kolicinaInput.closest('div[id^="unos-resurs-"]');
                        if (parentDiv) {
                            const resursId = parentDiv.id.replace('unos-resurs-', '');
                            const cena = parseFloat(ceneResursa[resursId]) || 0;
                            ukupno += kolicina * cena;
                        }
                    }
                });

                document.getElementById("ukupanTrosak").innerText = ukupno.toFixed(2);
                const hiddenUkupanTrosakInput = document.querySelector('input[name="UkupanTrosak"]');
                if (hiddenUkupanTrosakInput) {
                    hiddenUkupanTrosakInput.value = ukupno.toFixed(2);
                }
            }

            // Koristimo "event delegation" - jedan listener na kontejneru umesto mnogo njih na inputima
            resursDetaljiContainer.addEventListener('input', function (e) {
                // Ako je događaj potekao od inputa za količinu, preračunaj trošak
                if (e.target && e.target.classList.contains('resurs-kolicina-input')) {
                    izracunajUkupanTrosak();
                }
            });

            document.querySelectorAll('.resurs-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    const id = this.value;
                    const naziv = this.getAttribute('data-naziv');
                    let existingDiv = document.getElementById(`unos-resurs-${id}`);
                    const obrisaniResursiContainer = document.getElementById("obrisaniResursiContainer");

                    if (this.checked) {
                        // Ako polja već postoje (jer su bila deselektovana), samo ih prikaži i omogući
                        if (existingDiv) {
                            existingDiv.style.display = 'block';
                            existingDiv.querySelectorAll("input").forEach(i => i.disabled = false);
                        } else {
                            // Ako ne postoje, kreiraj ih
                            existingDiv = document.createElement("div");
                            existingDiv.classList.add("mb-3");
                            existingDiv.id = `unos-resurs-${id}`;
                            const index = resursBrojac++; // Koristi i inkrementiraj brojač
                            existingDiv.innerHTML = `
                                        <label class="form-label">Resurs: ${naziv} – količina</label>
                                        <input type="hidden" name="Resursi[${index}].IdResurs" value="${id}" />
                                        <input type="number" name="Resursi[${index}].Kolicina" class="form-control mb-2 resurs-kolicina-input" step="0.1" min="0" required />`;
                            resursDetaljiContainer.appendChild(existingDiv);
                        }
                        // Ukloni iz liste za brisanje ako je bio dodat
                        const hiddenInputZaBrisanje = document.getElementById(`obrisan-resurs-${id}`);
                        if (hiddenInputZaBrisanje) {
                            hiddenInputZaBrisanje.remove();
                        }
                    } else { // Ako je checkbox deselektovan
                        if (existingDiv) {
                            // Sakrij i OBAVEZNO onemogući polja. Onemogućena polja se ne šalju sa formom.
                            existingDiv.style.display = 'none';
                            existingDiv.querySelectorAll("input").forEach(i => i.disabled = true);
                        }
                        // Dodaj u listu za brisanje na serveru (samo ako već nije tamo)
                        if (!document.getElementById(`obrisan-resurs-${id}`)) {
                            const hiddenInput = document.createElement("input");
                            hiddenInput.type = "hidden";
                            hiddenInput.name = "ObrisaniResursiId[]";
                            hiddenInput.value = id;
                            hiddenInput.id = `obrisan-resurs-${id}`;
                            obrisaniResursiContainer.appendChild(hiddenInput);
                        }
                    }
                    // Nakon SVAKE promene, ponovo izračunaj ukupan trošak
                    izracunajUkupanTrosak();
                });
            });

            // Inicijalno izračunavanje troška prilikom učitavanja stranice
            izracunajUkupanTrosak();
        });
        document.addEventListener("DOMContentLoaded", function () {
            const parcelaSelect = document.getElementById("parcelaSelect");
            const label = document.getElementById("slobodnaPovrsinaLabel");

            parcelaSelect?.addEventListener("change", async function () {
                const id = this.value;
                if (!id) {
                    label.textContent = "Dostupna površina: -";
                    return;
                }

                try {
                    const response = await fetch(`/radnje/slobodnaPovrsina/${id}`);
                    if (response.ok) {
                        const data = await response.json();
                        label.textContent = `Dostupna površina: ${data.slobodno.toFixed(4)} ha`;
                    } else {
                        label.textContent = "Greška prilikom učitavanja.";
                    }
                } catch {
                    label.textContent = "Greška prilikom učitavanja.";
                }
            });
        });
        // =====================
        // Klijentska validacija
        // =====================
        document.querySelector("form").addEventListener("submit", function (e) {
            let valid = true;
            const tipRadnje = parseInt(document.getElementById("TipRadnje")?.value);
            const povrsina = document.querySelector("[name='Povrsina']");
            const prinos = document.querySelector("[name='Prinos']");
            const masinaInputs = document.querySelectorAll('.masina-checkbox:checked');
            const resursInputs = document.querySelectorAll('.resurs-checkbox:checked');

            // Resetuje staru vizuelnu validaciju
            document.querySelectorAll(".is-invalid").forEach(i => i.classList.remove("is-invalid"));

            // Setva → površina obavezna
            if (tipRadnje === @((int)MojAtar.Core.Domain.Enums.RadnjaTip.Setva)) {
                if (!povrsina.value || parseFloat(povrsina.value) <= 0) {
                    povrsina.classList.add("is-invalid");
                    valid = false;
                }
            }

            // Žetva → prinos obavezan
            if (tipRadnje === @((int)MojAtar.Core.Domain.Enums.RadnjaTip.Zetva)) {
                if (!prinos.value || parseFloat(prinos.value) <= 0) {
                    prinos.classList.add("is-invalid");
                    valid = false;
                }
            }

            // Radne mašine → mora imati unesene sate
            masinaInputs.forEach(chk => {
                const id = chk.value;
                const input = document.querySelector(`#unos-masina-${id} input[name*='BrojRadnihSati']`);
                if (input && (!input.value || parseFloat(input.value) <= 0)) {
                    input.classList.add("is-invalid");
                    valid = false;
                }
            });

            // Resursi → mora imati unetu količinu
            resursInputs.forEach(chk => {
                const id = chk.value;
                const input = document.querySelector(`#unos-resurs-${id} input[name*='Kolicina']`);
                if (input && (!input.value || parseFloat(input.value) <= 0)) {
                    input.classList.add("is-invalid");
                    valid = false;
                }
            });

            if (!valid) {
                e.preventDefault();
                alert("Molimo popunite obavezna polja za izabrane opcije.");
            }
        });
    </script>
}